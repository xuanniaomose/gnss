<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>河南省地图</title>
        <!-- 使用本地Leaflet CSS -->
        <link rel="stylesheet" href="file:///android_asset/leaflet/leaflet.css" />
        <style>
            * { margin: 0; padding: 0; }
            #map {
                width: 100%;
                height: 100vh;
                background: #f0f0f0;
            }
            .info-panel {
                position: absolute;
                bottom: 10px;
                right: 50px;
                background: white;
                padding: 8px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 300px;
            }.icon-button {
                width: 35px;
                height: 35px;
                background-color: rgba(220,220,220,0.8);
                border: none;
                color: white;
                padding: 4px;
                border-radius: 5px;
                align-content: center;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="info-panel">
            <div id="coordinates">经纬度：--</div>
        </div>

        <button class="icon-button" onclick="focusLocation()" style="position: absolute; bottom: 100px; right: 10px; z-index: 1000;">
            <img src="file:///android_asset/leaflet/images/locate.png" width="30" alt="图片">
        </button>
        <div id="map"></div>

        <!-- 使用本地Leaflet JS -->
        <script src="file:///android_asset/leaflet/leaflet.js"></script>
        <!-- 使用本地天地图插件 -->
        <script src="file:///android_asset/leaflet/leaflet-tilelayer.china.local.js"></script>
        <script src="file:///android_asset/leaflet/leaflet.rotatedMarker.js"></script>
        <script>
            // 全局变量需要写在图层前面
            let map;
            var lastPoint = getLastPoint();
            let locationMark;
            let accuracyCircle;
            let isInitialized = false;
            let polylineHistory = [];
            var headingDegrees = 0;
            var maxLineNum = 1000;
            var isTracking;
            var busMarkers = [];
            var tk = getEffectiveTiandituKey(); // 天地图密钥

            const arrowIcon = L.icon({
                // 替换为你自己的箭头图标路径（建议使用PNG透明图）
                iconUrl: 'file:///android_asset/leaflet/images/pointnow.png',
                // 图标尺寸（根据你的图标实际尺寸调整）
                iconSize: [20, 29],
                // 图标锚点（箭头尖端对应坐标点）
                iconAnchor: [10, 20],
                // 弹出框锚点
                popupAnchor: [1, -34],
                // 提示文本锚点
                tooltipAnchor: [16, -28]
            });

            initMap();

            // 接收Android发送的位置更新
            window.onLocationUpdate = function(locationData) {
                const lat = locationData.lat;
                const lng = locationData.lng;
                console.log("收到位置数据:", lat);
                const accuracy = locationData.accuracy || 50;
                const bearing = locationData.bearing || 0;
                newLatLng = [lat, lng];
                updateLocation(newLatLng, accuracy, bearing);
                if (isTracking) updateTrack(newLatLng);
                lastPoint = newLatLng;
            };

            window.onBearingUpdate = function(angle) {
                headingDegrees = angle.degrees;
//                console.log("收到朝向数据:", headingDegrees);
                map.removeLayer(locationMark);
                locationMark = L.marker(lastPoint, {
                    icon: arrowIcon,
                    rotationAngle: headingDegrees
                });
                locationMark.addTo(map);
            }

            // 开始绘制轨迹
            window.drawTrack = function(isTrack) {
                console.log("开始绘制");
                isTracking = isTrack
            }

            // 清除轨迹
            window.clearTrack = function() {
                polylineHistory = [];
                if (polyline) {
                    polyline.setLatLngs([]);
                }
            };

            function initMap() {
                // 河南省的边界范围（大致）
                var henanBounds = {
                    north: 36.5,    // 安阳附近
                    south: 24.5,    // 湖南永州附近
                    east: 116.8,    // 商丘附近
                    west: 110.3     // 三门峡附近
                };

                // 初始化地图，限定在河南省范围内
                map = L.map('map', {
                    center: lastPoint,
                    zoom: 14,
                    minZoom: 6,
                    maxZoom: 18,
                    maxBounds: [
                        [henanBounds.south - 0.5, henanBounds.west - 0.5],
                        [henanBounds.north + 0.5, henanBounds.east + 0.5]
                    ],
                    maxBoundsViscosity: 1.0  // 严格限制边界
                });

                // 添加天地图底图（矢量）
                var baseLayer = L.tileLayer(
                    'https://t{s}.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=' + tk, {
                        subdomains: ['0','1','2','3','4','5','6','7'],
                        maxZoom: 18,
                        useCache: true,
                        crossOrigin: true,
                        cacheMaxAge: 360 * 24 * 60 * 60 * 1000 // 360天
                    }
                ).addTo(map);

                // 创建并添加注记图层启用缓存
                var annotationLayer = L.tileLayer(
                    'https://t{s}.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=' + tk, {
                        subdomains: ['0','1','2','3','4','5','6','7'],
                        maxZoom: 18,
                        useCache: true,
                        crossOrigin: true,
                        cacheMaxAge: 360 * 24 * 60 * 60 * 1000 // 360天
                    }
                ).addTo(map);
                console.log('底图与注记图层已添加到地图。');

                // 显示点击位置的坐标
                var coordsDisplay = document.getElementById('coordinates');
                map.on('mousemove', function(e) {
                    coordsDisplay.innerHTML = "经纬度: " +
                    e.latlng.lng.toFixed(6) + "°, " +
                    e.latlng.lat.toFixed(6) + "°";
                });

                // 添加比例尺控件
                L.control.scale({imperial: false}).addTo(map);

                // 注明图源
                L.control.attribution({prefix: '天地图'}).addTo(map);

                locationMark = L.marker(lastPoint, {
                    icon: arrowIcon,
                    rotationAngle: 90
                });
                locationMark.addTo(map);
                accuracyCircle = L.circle(lastPoint, {radius: 50});
                accuracyCircle.addTo(map);

                isInitialized = true
                // 通知Android地图已准备好
                if (window.AndroidLocation) {
                    AndroidLocation.requestLocationUpdate();
                }
            }

            // 更新当前位置
            function updateLocation(newLatLng, accuracy, bearing) {
                if (Math.abs(bearing - headingDegrees) > 10) {
                    bearing = headingDegrees;
                }
                // 移除上一个标记位置
                map.removeLayer(locationMark);
                locationMark = L.marker(newLatLng, {
                    icon: arrowIcon,
                    rotationAngle: bearing
                });
                // 更新标记位置
                locationMark.addTo(map);
                // 移除上一个精度圆
                map.removeLayer(accuracyCircle);
                // 更新精度圆
                accuracyCircle = L.circle(newLatLng, {radius: accuracy});
                accuracyCircle.addTo(map);
            }

            // 更新当前轨迹
            function updateTrack(newLatLng) {
                // 删除上一段轨迹
                if (polylineHistory.length > 0) {
                    var earliestPolyline = polylineHistory[0]
                    map.removeLayer(earliestPolyline);
                }
                // 更新轨迹
                polylineHistory.push(newLatLng);
                if (polylineHistory.length > maxLineNum) {
                    polylineHistory.shift();
                }
                var polyline = L.polyline([lastPoint, newLatLng], {color: 'blue'});
                polyline.addTo(map);
            }

            // 聚焦当前位置
            function focusLocation() {
                map.setView(lastPoint, 18)
            }

            /**
             * 获取有效的天地图密钥。
             * 优先级：1. Android接口实时获取 > 2. 全局变量中的备用密钥。
             * @returns {string} 获取到的密钥字符串。如果无效，则返回空字符串。
             */
            function getEffectiveTiandituKey() {
                var tk = ''; // 初始化密钥变量
                // 1. 优先尝试通过Android原生接口获取
                if (typeof AndroidLocation !== 'undefined' && AndroidLocation.getTiandituKey) {
                    tk = AndroidLocation.getTiandituKey();
                    console.log("通过AndroidLocation接口获取密钥:", tk ? "成功" : "获取到的值为空");
                } else {
                    // 2. 降级方案：使用WebView初始化时注入的全局备用密钥
                    tk = (typeof window.USER_TIANDITU_KEY !== 'undefined') ? window.USER_TIANDITU_KEY : '';
                    console.warn("AndroidLocation接口不可用，尝试使用备用全局密钥:", tk ? "存在" : "不存在");
                }

                // 3. 检查密钥有效性（可根据需要调整条件）
                // 这里检查是否为空、是否为默认占位符。假设默认占位符包含'YOUR_DEFAULT'或'YOUR_OLD_HARDCODED_KEY'
                if (!tk || /YOUR_(DEFAULT|OLD_HARDCODED)_KEY/.test(tk)) {
                    console.error("获取到的天地图密钥无效或为默认值:", tk);
                    // 注意：此处不进行UI提示（如alert），仅在控制台报错，将错误处理权交给调用者。
                    return ''; // 返回空字符串表示获取失败
                }

                // 4. 返回有效的密钥
                console.log("使用有效密钥（已隐藏部分）:", tk.substring(0, 4) + '...');
                return tk;
            }

            // 获取上一个位置
            function getLastPoint() {
                latLng = ''
                if (typeof AndroidLocation !== 'undefined' && AndroidLocation.getLastLocation) {
                    latLng = AndroidLocation.getLastLocation();
                    console.log("通过AndroidLocation接口获取初始位置:", latLng? "成功" : "获取到的值为空");
                } else {
                    latLng = (typeof window.LAST_POINT !== 'undefined') ? window.LAST_POINT : '';
                    console.log("AndroidLocation接口不可用，尝试使用备用全局初始位置:", latLng? "存在" : "不存在");
                }
                if (latLng !== '' && latLng != '200.0,200.0') {
                    lastPoint = latLng.split(",")
                } else {
                    lastPoint = [114.3031, 34.8183];
                }
                return lastPoint;
            }
        </script>
    </body>
</html>