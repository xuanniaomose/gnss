<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ²³å—çœåœ°å›¾</title>
    <!-- ç¼“å­˜ä½¿ç”¨çš„localForageåº“ï¼Œå®ƒèƒ½æå¤§åœ°ç®€åŒ–å¯¹IndexedDBçš„æ“ä½œ-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <!-- ä½¿ç”¨æœ¬åœ°Leaflet CSS -->
    <link rel="stylesheet" href="file:///android_asset/leaflet/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; }
        #map {
            width: 100%;
            height: 100vh;
            background: #f0f0f0;
        }
        .info-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }
        .province-boundary {
            color: #1890ff;
            fillColor: #1890ff33;
            weight: 3;
            fillOpacity: 0.2;
        }
        #debug-info {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.85); color: #0f0;
            padding: 10px; border-radius: 5px;
            font-family: 'Courier New', monospace; font-size: 12px;
            z-index: 10000; max-height: 200px; overflow-y: auto;
        }
    </style>
</head>
<body>
<!-- æœç´¢æ¡† -->
<div class="search-panel" style="position: absolute; top: 10px; left: 55px; z-index: 1000; background: white; padding: 8px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
    <h4 style="margin-top:0;">å…¬äº¤çº¿è·¯æœç´¢</h4>
    <input type="text" id="busSearchInput" placeholder="è¾“å…¥å…¬äº¤çº¿è·¯åæˆ–å…³é”®è¯" style="width: 190px; padding: 5px;">
    <button onclick="searchBusLine()" style="padding: 3px 7px;">æœç´¢</button>
    <button onclick="document.getElementById('debug-info').style.display='block'" style="padding: 3px 7px;">è°ƒè¯•</button>
    <div id="searchResult" style="margin-top: 10px; font-size: 12px; max-width: 250px; max-height: 150px; overflow-y: auto;"></div>
</div>
<div class="info-panel">
    <div id="coordinates">ç»çº¬åº¦ï¼š--</div>
</div>
<div id="debug-info" style="display:none;">
    <button onclick="estimateCacheSize()" style="padding: 3px 7px;">ç¼“å­˜å¤§å°</button>
    <button onclick="clearTileCache()" style="padding: 3px 7px;">æ¸…ç©ºç¼“å­˜</button>
    <h4>è°ƒè¯•ä¿¡æ¯ <small onclick="this.parentElement.style.display='none'">[éšè—]</small></h4>
    <div id="debug-logs">æ­£åœ¨åˆå§‹åŒ–...</div>
</div>
<div id="map"></div>

<!-- ä½¿ç”¨æœ¬åœ°Leaflet JS -->
<script src="file:///android_asset/leaflet/leaflet.js"></script>
<!-- ä½¿ç”¨æœ¬åœ°å¤©åœ°å›¾æ’ä»¶ -->
<script src="file:///android_asset/leaflet/leaflet-tilelayer.china.local.js"></script>

<script>
    // å…¨å±€å˜é‡éœ€è¦å†™åœ¨å›¾å±‚å‰é¢
    let map;
    let locationMarker;
    let accuracyCircle;
    let polyline;
    let locationHistory = [];
    let isInitialized = false;

    var busMarkers = [];
    var tk = getEffectiveTiandituKey(); // å¤©åœ°å›¾å¯†é’¥

    initMap();

    // æ¥æ”¶Androidå‘é€çš„ä½ç½®æ›´æ–°
    window.onLocationUpdate = function(locationData) {
        console.log("æ”¶åˆ°ä½ç½®æ•°æ®:", locationData);

        const lat = locationData.lat;
        const lng = locationData.lng;
        const accuracy = locationData.accuracy || 50;
        const newLatLng = [lat, lng];

        // æ›´æ–°æ ‡è®°ä½ç½®
        map.removeLayer(locationMaker);

        // æ›´æ–°ç²¾åº¦åœ†
        map.removeLayer(accuracyCircle);

        // æ·»åŠ åˆ°å†å²è½¨è¿¹
        if (locationHistory.length > 5) {
            map.removeLayer(polyline);
        }

        setlayer(lat, lng)
        map.setView(newLatLng, 19);
    };

    // åœ°å›¾å±…ä¸­åˆ°æŒ‡å®šä½ç½®
    window.centerOnLocation = function(lat, lng) {
        if (map) {
            map.setView([lat, lng], map.getZoom());
            marker.setLatLng([lat, lng]);
            accuracyCircle.setLatLng([lat, lng]);
        }
    };

    // åœ°å›¾ç¼©æ”¾
    window.zoomMap = function(delta) {
        if (map) {
            if (delta > 0) {
                map.zoomIn();
            } else {
                map.zoomOut();
            }
        }
    };

    // æ¸…é™¤è½¨è¿¹
    window.clearTrack = function() {
        locationHistory = [];
        if (polyline) {
            polyline.setLatLngs([]);
        }
    };

    function initMap() {
        // æ²³å—çœçš„è¾¹ç•ŒèŒƒå›´ï¼ˆå¤§è‡´ï¼‰
        var henanBounds = {
            north: 36.5,    // å®‰é˜³é™„è¿‘
            south: 31.5,    // ä¿¡é˜³é™„è¿‘
            east: 116.8,    // å•†ä¸˜é™„è¿‘
            west: 110.3     // ä¸‰é—¨å³¡é™„è¿‘
        };
    <!--        south: 24.5,    // æ¹–å—æ°¸å·é™„è¿‘-->

        // è®¡ç®—ä¸­å¿ƒç‚¹å’Œé€‚åˆçš„ç¼©æ”¾çº§åˆ«
        var centerLng = 114.3031;
        var centerLat = 34.8183;

        // åˆå§‹åŒ–åœ°å›¾ï¼Œé™å®šåœ¨æ²³å—çœèŒƒå›´å†…
        map = L.map('map', {
            center: [centerLat, centerLng],
            zoom: 14,
            minZoom: 6,
            maxZoom: 20,
            maxBounds: [
                [henanBounds.south - 0.5, henanBounds.west - 0.5],
                [henanBounds.north + 0.5, henanBounds.east + 0.5]
            ],
            maxBoundsViscosity: 1.0  // ä¸¥æ ¼é™åˆ¶è¾¹ç•Œ
        });

        // æ·»åŠ å¤©åœ°å›¾åº•å›¾ï¼ˆçŸ¢é‡ï¼‰
        var baseLayer = L.tileLayer(
            'https://t{s}.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=' + tk, {
                subdomains: ['0','1','2','3','4','5','6','7'],
                maxZoom: 20,
                useCache: true,
                crossOrigin: true,
                cacheMaxAge: 180 * 24 * 60 * 60 * 1000 // 180å¤©
            }
        ).addTo(map);

        // åˆ›å»ºå¹¶æ·»åŠ æ³¨è®°å›¾å±‚å¯ç”¨ç¼“å­˜
        var annotationLayer = L.tileLayer(
            'https://t{s}.tianditu.gov.cn/DataServer?T=cva_w&x={x}&y={y}&l={z}&tk=' + tk, {
                subdomains: ['0','1','2','3','4','5','6','7'],
                maxZoom: 20,
                useCache: true,
                crossOrigin: true,
                cacheMaxAge: 180 * 24 * 60 * 60 * 1000 // 180å¤©
            }
        ).addTo(map);
        console.log('åº•å›¾ä¸æ³¨è®°å›¾å±‚å·²æ·»åŠ åˆ°åœ°å›¾ã€‚');

        // æ˜¾ç¤ºç‚¹å‡»ä½ç½®çš„åæ ‡
        var coordsDisplay = document.getElementById('coordinates');
        map.on('mousemove', function(e) {
            coordsDisplay.innerHTML = "ç»çº¬åº¦: " +
                e.latlng.lng.toFixed(6) + "Â°, " +
                e.latlng.lat.toFixed(6) + "Â°";
        });

        // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶
        L.control.scale({imperial: false}).addTo(map);

        // æ·»åŠ å›¾å±‚æ§åˆ¶ï¼ˆå¯åˆ‡æ¢æ³¨è®°ï¼‰ï¼ˆè¿™æ®µæœ‰é—®é¢˜ï¼‰
        //var baseLayers = {
        //    "å¤©åœ°å›¾åº•å›¾": baseLayer
        //};
        //var overlays = {
        //    "å¤©åœ°å›¾æ³¨è®°": annotationLayer,
        //    "çœç•Œ": null  // å·²åœ¨åˆå§‹åŒ–æ—¶æ·»åŠ 
        //};
        //L.control.layers(baseLayers, overlays).addTo(map);

        // æ·»åŠ ç®€å•çš„ä½ç½®æ§ä»¶
        L.control.attribution({prefix: 'åº•å›¾: å¤©åœ°å›¾'}).addTo(map);

        isInitialized = true

        // é€šçŸ¥Androidåœ°å›¾å·²å‡†å¤‡å¥½
        if (window.Android) {
            Android.requestLocationUpdate();
        }

        setlayer(centerLat, centerLng)
    }

    function setlayer(lat, lng) {
        const newLatLng = [lat, lng];
        locationMaker = L.marker(newLatLng);
        locationMaker.addTo(map);
        accuracyCircle = L.circle(newLatLng, {radius: 50});
        accuracyCircle.addTo(map);
        locationHistory.push(newLatLng);
        if (locationHistory.length > 100) {
            locationHistory.shift();
        }
        polyline = L.polyline(locationHistory, {color: 'blue'});
        if (locationHistory.length > 5) {
            polyline.addTo(map);
        }
    }

    // æœç´¢é€»è¾‘
    function searchBusLine() {
        var keyword = document.getElementById('busSearchInput').value;
        if (!keyword) {
            alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            return;
        }

        // 1. è·å–å½“å‰åœ°å›¾çš„æ˜¾ç¤ºèŒƒå›´ (æ²³å—çœå†…)
        var bounds = map.getBounds();
        var mapBounds = bounds.getSouthWest().lng + ',' +
                        bounds.getSouthWest().lat + ',' +
                        bounds.getNorthEast().lng + ',' +
                        bounds.getNorthEast().lat;

        // 2. æ„å»ºè¯·æ±‚URL (ä½¿ç”¨åœ°åæœç´¢æœåŠ¡V2.0)
        // ç”±è°ƒç”¨è€…å¤„ç†å¯†é’¥æ— æ•ˆçš„æƒ…å†µ
        if (!tk) {
            // ä¾‹å¦‚ï¼šåœ¨æœç´¢ç»“æœçš„DOMä½ç½®æ˜¾ç¤ºé”™è¯¯
            document.getElementById('searchResult').innerHTML = '<span style="color:red;">é”™è¯¯ï¼šæœªé…ç½®æœ‰æ•ˆçš„å¤©åœ°å›¾å¯†é’¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚</span>';
            // æˆ–è€…å¯ä»¥å¼¹å‡ºæç¤º
            // alert('è¯·å…ˆåœ¨åº”ç”¨çš„è®¾ç½®é¡µé¢ä¸­é…ç½®æœ‰æ•ˆçš„å¤©åœ°å›¾å¯†é’¥ï¼');
            return; // åœæ­¢æœç´¢
        }
        var baseUrl = 'https://api.tianditu.gov.cn/v2/search';
        var params = {
            'postStr': JSON.stringify({
                'keyWord': keyword,
                'level': '11',          // å¯ä»¥è°ƒæ•´ï¼Œæ•°å­—ä»£è¡¨æœç´¢ç²¾ç»†åº¦
                'mapBound': mapBounds,  // å°†æœç´¢èŒƒå›´é™å®šåœ¨å½“å‰è§†é‡
                'queryType': '1',       // æŸ¥è¯¢ç±»å‹ï¼Œå¯å°è¯•è°ƒæ•´
                'count': '20',          // è¿”å›ç»“æœæ•°é‡
                'start': '0'            // åˆ†é¡µèµ·å§‹ï¼Œ0è¡¨ç¤ºä»ç¬¬ä¸€æ¡å¼€å§‹
            }),
            'type': 'query',
            'tk': tk
        };
        var queryString = Object.keys(params).map(key => key + '=' + encodeURIComponent(params[key])).join('&');
        var url = baseUrl + '?' + queryString;
        document.getElementById('debug-logs').innerHTML = url
        console.log('æœç´¢url:', url);

        // 3. å‘é€æœç´¢è¯·æ±‚
        fetch(url)
            .then(response => {
                console.log('å“åº”çŠ¶æ€:', response.status, response.ok);
                if (!response.ok) {
                    // å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯200-299ï¼ŒæŠ›å‡ºé”™è¯¯ä»¥ä¾¿è¿›å…¥catchå—
                    document.getElementById('debug-logs').innerHTML = `ç½‘ç»œå“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`
                    throw new Error(`ç½‘ç»œå“åº”å¼‚å¸¸: ${response.status} ${response.statusText}`);
                }
                    return response.json();
                })
                .then(data => {
                    displayBusResults(data);
                })
                .catch(error => {
                    console.error('æœç´¢è¯·æ±‚å¤±è´¥è¯¦æƒ…:', error);
                    // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    document.getElementById('searchResult').innerHTML =
                        '<span style="color:red;">æœç´¢å¤±è´¥: ' +
                        (error.message || 'æœªçŸ¥ç½‘ç»œé”™è¯¯') +
                        '<br>è¯·æ£€æŸ¥è®¾å¤‡ç½‘ç»œè¿æ¥ã€‚</span>';
                });
    }

    /**
     * è·å–æœ‰æ•ˆçš„å¤©åœ°å›¾å¯†é’¥ã€‚
     * ä¼˜å…ˆçº§ï¼š1. Androidæ¥å£å®æ—¶è·å– > 2. å…¨å±€å˜é‡ä¸­çš„å¤‡ç”¨å¯†é’¥ã€‚
     * @returns {string} è·å–åˆ°çš„å¯†é’¥å­—ç¬¦ä¸²ã€‚å¦‚æœæ— æ•ˆï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
     */
    function getEffectiveTiandituKey() {
        var tk = ''; // åˆå§‹åŒ–å¯†é’¥å˜é‡

        // 1. ä¼˜å…ˆå°è¯•é€šè¿‡AndroidåŸç”Ÿæ¥å£è·å–
        if (typeof Android !== 'undefined' && Android.getTiandituKey) {
            tk = Android.getTiandituKey();
            console.log("é€šè¿‡Androidæ¥å£è·å–å¯†é’¥:", tk ? "æˆåŠŸ" : "è·å–åˆ°çš„å€¼ä¸ºç©º");
        } else {
            // 2. é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨WebViewåˆå§‹åŒ–æ—¶æ³¨å…¥çš„å…¨å±€å¤‡ç”¨å¯†é’¥
            tk = (typeof window.USER_TIANDITU_KEY !== 'undefined') ? window.USER_TIANDITU_KEY : '';
            console.warn("Androidæ¥å£ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨å…¨å±€å¯†é’¥:", tk ? "å­˜åœ¨" : "ä¸å­˜åœ¨");
        }

        // 3. æ£€æŸ¥å¯†é’¥æœ‰æ•ˆæ€§ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´æ¡ä»¶ï¼‰
        // è¿™é‡Œæ£€æŸ¥æ˜¯å¦ä¸ºç©ºã€æ˜¯å¦ä¸ºé»˜è®¤å ä½ç¬¦ã€‚å‡è®¾é»˜è®¤å ä½ç¬¦åŒ…å«'YOUR_DEFAULT'æˆ–'YOUR_OLD_HARDCODED_KEY'
        if (!tk || /YOUR_(DEFAULT|OLD_HARDCODED)_KEY/.test(tk)) {
            console.error("è·å–åˆ°çš„å¤©åœ°å›¾å¯†é’¥æ— æ•ˆæˆ–ä¸ºé»˜è®¤å€¼:", tk);
            // æ³¨æ„ï¼šæ­¤å¤„ä¸è¿›è¡ŒUIæç¤ºï¼ˆå¦‚alertï¼‰ï¼Œä»…åœ¨æ§åˆ¶å°æŠ¥é”™ï¼Œå°†é”™è¯¯å¤„ç†æƒäº¤ç»™è°ƒç”¨è€…ã€‚
            return ''; // è¿”å›ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºè·å–å¤±è´¥
        }

        // 4. è¿”å›æœ‰æ•ˆçš„å¯†é’¥
        console.log("ä½¿ç”¨æœ‰æ•ˆå¯†é’¥ï¼ˆå·²éšè—éƒ¨åˆ†ï¼‰:", tk.substring(0, 4) + '...');
        return tk;
    }

    function displayBusResults(data) {
        // 1. æ¸…é™¤ä¹‹å‰çš„æ ‡è®°å’Œç»“æœ
        busMarkers.forEach(marker => map.removeLayer(marker));
        busMarkers = [];
        var resultDiv = document.getElementById('searchResult');
        resultDiv.innerHTML = '';
        console.log('ç»“æœ:', data.toString());
        // 2. æ£€æŸ¥æ•°æ®çŠ¶æ€ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
        if (!data) {
            resultDiv.innerHTML = '<span style="color:red;">é”™è¯¯ï¼šæœªæ¥æ”¶åˆ°æœ‰æ•ˆæ•°æ®ã€‚</span>';
            return;
        }
        if (data.status && data.status.infocode != 1000) {
            resultDiv.innerHTML = '<span style="color:orange;">æœåŠ¡æç¤ºï¼š' + (data.status.cndesc || 'è¯·æ±‚å¼‚å¸¸') + '</span>';
            return;
        }

        // 3. å®šä¹‰è¦å¤„ç†çš„æ•°æ®æ•°ç»„ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        //    æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œè¿™é‡Œä¼˜å…ˆå±•ç¤ºå…¬äº¤çº¿è·¯(lineData)ï¼Œå…¶æ¬¡æ‰æ˜¯åœ°ç‚¹(pois)
        var itemsToShow = [];
        var resultType = 'unknown';

        if (data.lineData && Array.isArray(data.lineData) && data.lineData.length > 0) {
            itemsToShow = data.lineData;
            resultType = 'line'; // å…¬äº¤çº¿è·¯
            console.log('å…¬äº¤çº¿è·¯:', itemsToShow.toString());
        } else if (data.pois && Array.isArray(data.pois) && data.pois.length > 0) {
            itemsToShow = data.pois;
            resultType = 'poi'; // å…´è¶£ç‚¹
        }

        // 4. æ ¹æ®æ•°æ®ç±»å‹è¿›è¡Œå±•ç¤º
        if (itemsToShow.length === 0) {
            resultDiv.innerHTML = '<span style="color:gray;">æœªæ‰¾åˆ°ä¸å…³é”®è¯ç²¾ç¡®åŒ¹é…çš„å…¬äº¤çº¿è·¯æˆ–åœ°ç‚¹ã€‚</span>';
            console.log('æ— å…·ä½“ç»“æœï¼Œä½†æœåŠ¡å™¨è¿”å›äº†:', data); // å¯æŸ¥çœ‹å®Œæ•´è¿”å›
            return;
        }

        // æ˜¾ç¤ºç»“æœæ•°é‡å’Œä¿¡æ¯
        var count = itemsToShow.length || data.count;
        resultDiv.innerHTML += `<div style="color:#666; margin-bottom:8px;">æ‰¾åˆ° ${count} æ¡ç»“æœ (${resultType})</div>`;

        // 5. éå†å¹¶åˆ›å»ºæ¯ä¸ªç»“æœçš„æ˜¾ç¤ºé¡¹
        itemsToShow.forEach(function(item, index) {
            var itemDiv = document.createElement('div');
            itemDiv.style.padding = '8px';
            itemDiv.style.marginBottom = '6px';
            itemDiv.style.border = '1px solid #eee';
            itemDiv.style.borderRadius = '4px';
            itemDiv.style.backgroundColor = '#f9f9f9';

            var name = item.name || 'æœªå‘½å';
            var poiType = item.poiType || 'æœªçŸ¥ç±»å‹';

            // æ ¹æ®ç±»å‹ç»„è£…ä¸åŒçš„ä¿¡æ¯
            var infoHtml = `<strong>${name}</strong><br>`;
            if (resultType === 'line') {
                // å…¬äº¤çº¿è·¯ä¿¡æ¯
                var stationNum = item.stationNum || '?';
                infoHtml += `ç±»å‹ï¼šå…¬äº¤çº¿è·¯ (${poiType}) | ç«™ç‚¹æ•°ï¼š${stationNum}<br>`;
                infoHtml += `<button onclick="alert('çº¿è·¯UUID: ${item.uuid}\\nå¦‚éœ€å±•ç¤ºè¯¦ç»†èµ°å‘ï¼Œéœ€è°ƒç”¨å…¶ä»–æ¥å£è·å–åæ ‡ã€‚')" style="margin-top:4px; padding:2px 8px; font-size:11px;">æŸ¥çœ‹è¯¦æƒ…</button>`;
            } else {
                // POIå…´è¶£ç‚¹ä¿¡æ¯
                var address = item.address || 'åœ°å€ä¸è¯¦';
                infoHtml += `åœ°å€ï¼š${address}<br>`;
                infoHtml += `ç”µè¯ï¼š${item.phone || 'æ— '}<br>`;
                // å°è¯•åœ¨åœ°å›¾ä¸Šæ ‡è®°POIï¼ˆå¦‚æœæœ‰åæ ‡ï¼‰
                if (item.lonlat) {
                    var coords = item.lonlat.split(',');
                    if (coords.length === 2) {
                        var lat = parseFloat(coords[1]);
                        var lon = parseFloat(coords[0]);
                        var marker = L.marker([lat, lon])
                            .bindPopup(`<b>${name}</b><br>${address}`);
                        marker.addTo(map);
                        busMarkers.push(marker);
                        infoHtml += `<button onclick="map.setView([${lat}, ${lon}], 15); this.parentElement.parentElement.style.backgroundColor='#e6f7ff';" style="margin-top:4px; padding:2px 8px; font-size:11px;">åœ¨åœ°å›¾å®šä½</button>`;
                    }
                }
            }

            itemDiv.innerHTML = infoHtml;
            resultDiv.appendChild(itemDiv);
        });

        // 6. å¦‚æœæœç´¢åˆ°äº†çº¿è·¯ï¼Œæç¤ºç”¨æˆ·
        if (resultType === 'line') {
            resultDiv.innerHTML += `<div style="margin-top:10px; padding:8px; background-color:#e8f5e9; border-radius:4px; color:#2e7d32;">
                <small>ğŸ’¡ å·²æ‰¾åˆ°å…¬äº¤çº¿è·¯ã€‚ç‚¹å‡»â€œæŸ¥çœ‹è¯¦æƒ…â€å¯è·å–çº¿è·¯IDã€‚å¦‚éœ€åœ¨åœ°å›¾ä¸Šç»˜åˆ¶å®Œæ•´çº¿è·¯ï¼Œéœ€è¦ä½¿ç”¨çº¿è·¯IDè°ƒç”¨â€œå…¬äº¤çº¿è·¯è¯¦æƒ…â€æ¥å£ã€‚</small>
            </div>`;
        }
    }

    // ç‚¹å‡»ç»“æœæ—¶å±…ä¸­æ˜¾ç¤ºè¯¥ç‚¹
    function centerAndShow(index) {
        if (busMarkers[index]) {
            map.setView(busMarkers[index].getLatLng(), 14);
            busMarkers[index].openPopup();
        }
    }

    // è°ƒè¯•æ—¥å¿—å‡½æ•°
    function debugLog(msg) {
        var logDiv = document.getElementById('debug-logs');
        var entry = document.createElement('div');
        entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
        logDiv.appendChild(entry);
        console.log(msg);
    }

    // ä¼°ç®—å½“å‰ç¼“å­˜å¤§å° (è¿‘ä¼¼å€¼)
    function estimateCacheSize() {
        localforage.length().then(function(count) {
            alert(`å½“å‰å¤§çº¦ç¼“å­˜äº† ${count} å¼ ç“¦ç‰‡ã€‚`);
            console.log(`ç¼“å­˜ç“¦ç‰‡æ•°é‡: ${count}`);
            debugLog(`ç¼“å­˜ç“¦ç‰‡æ•°é‡: ${count}`)
        });
    }

    // æ¸…ç©ºæ‰€æœ‰ç“¦ç‰‡ç¼“å­˜
    function clearTileCache() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¦»çº¿åœ°å›¾ç¼“å­˜å—ï¼Ÿ')) {
            localforage.iterate(function(value, key, iterationNumber) {
                if (key.startsWith('tile_')) {
                    return localforage.removeItem(key);
                }
            }).then(function() {
                alert('ç¦»çº¿ç¼“å­˜å·²æ¸…ç©ºï¼');
                location.reload(); // åˆ·æ–°é¡µé¢ä½¿åœ°å›¾é‡æ–°åŠ è½½
            });
        }
    }
</script>
</body>
</html>